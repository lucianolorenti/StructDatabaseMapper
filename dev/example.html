<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example · Struct Database Mapping</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Struct Database Mapping</span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li><a class="tocitem" href="api.html">Api</a></li><li class="is-active"><a class="tocitem" href="example.html">Example</a><ul class="internal"><li><a class="tocitem" href="#Let&#39;s-define-a-model-1"><span>Let&#39;s define a model</span></a></li><li><a class="tocitem" href="#Existence-1"><span>Existence</span></a></li><li><a class="tocitem" href="#Update-1"><span>Update</span></a></li><li class="toplevel"><a class="tocitem" href="#Insert-element-with-foreign-key-and-dict-1"><span>Insert element with foreign key and dict</span></a></li><li class="toplevel"><a class="tocitem" href="#Delete-1"><span>Delete</span></a></li><li class="toplevel"><a class="tocitem" href="#Removing-tables-1"><span>Removing tables</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="example.html">Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="example.html">Example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/lucianolorenti/StructDatabaseMapping.jl/blob/master/docs/src/example.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Example-1"><a class="docs-heading-anchor" href="#Example-1">Example</a><a class="docs-heading-anchor-permalink" href="#Example-1" title="Permalink"></a></h1><h2 id="Let&#39;s-define-a-model-1"><a class="docs-heading-anchor" href="#Let&#39;s-define-a-model-1">Let&#39;s define a model</a><a class="docs-heading-anchor-permalink" href="#Let&#39;s-define-a-model-1" title="Permalink"></a></h2><p>This is a simple model. There are four new types to introduce: Model, ForeignKey, DBId and Foreign.</p><ul><li>Model is the abstact type every struct to be persisted should inherit from</li><li>ForeignKey is a generic type that represents a reference to other Model</li><li>DBId is other generic type that encodes the struct identifier.</li><li>Foreign is used as datatype in the constructor of a struct that contains a ForeignKey field. That datatype is bit of hack I don&#39;t like, but I couldn&#39;t find a  better way.</li></ul><p>Each <code>type &lt;: Model</code> must have a construcor with named parameters.</p><p>The DBMapper type is the main type of the library. The mapper is constructed with a function passed as an argument.</p><pre><code class="language-julia">using StructDatabaseMapping
using Dates
using SQLite
using Test

mutable struct Author &lt;: Model
    id::DBId{Integer}
    name::String
    age::Integer
    date::DateTime
end
function Author(;id::Union{Integer, Nothing} = nothing,
                name::String=&quot;&quot;,
                age::Integer=0,
                date::DateTime=now())
    return Author(id, name, age, date)
end
mutable struct Book &lt;: Model
    id::DBId{String}
    author::ForeignKey{Author}
    data::Dict{String, Integer}
end
function Book(;id::Union{String, Nothing}=nothing,
               author::Foreign{Author}=Author(),
               data::Dict{String, Integer}=Dict())
    return Book(id, author, data)
end</code></pre><p>First we should create the DBMapper and register our types</p><pre><code class="language-julia">DB_FILE = &quot;test_db&quot;
using SQLite
creator = ()-&gt;SQLite.DB(DB_FILE)
mapper = DBMapper(creator)

register!(mapper, Author)
register!(mapper, Book)

configure_relation(mapper, Book, :author, on_delete=Cascade())

@test haskey(mapper.tables, Author)
@test haskey(mapper.tables, Book)

create_table(mapper, Author)
create_table(mapper, Book)</code></pre><pre><code class="language-none">[ Info: CREATE TABLE IF NOT EXISTS author (age INTEGER NOT NULL, date DATETIME NOT NULL, id INTEGER PRIMARY KEY, name VARCHAR NOT NULL)
[ Info: CREATE TABLE IF NOT EXISTS book (author_id INTEGER NOT NULL, data JSON NOT NULL, id VARCHAR PRIMARY KEY, FOREIGN KEY(author_id) REFERENCES author(id) ON DELETE CASCADE ON UPDATE NO ACTION)</code></pre><pre><code class="language-julia">author = Author(name=&quot;pirulo&quot;, age=50)
insert!(mapper, author)
@test !isnothing(getid(author, mapper))
println(author)</code></pre><pre><code class="language-none">┌ Info: INSERT INTO author (age,date,name)
└ VALUES (?,?,?)
Main.ex-code_1.Author(DBId{Integer}(1), &quot;pirulo&quot;, 50, 2020-03-07T12:09:25.79)</code></pre><pre><code class="language-julia">id = getid(author, mapper)
a = select_one(mapper, Author, id=999)
println(a)</code></pre><pre><code class="language-none">┌ Info: SELECT age, date, id, name
│ FROM author
│ WHERE id=?
└  LIMIT 1
nothing</code></pre><pre><code class="language-julia">a = select_one(mapper, Author, id=id)
println(a)</code></pre><pre><code class="language-none">┌ Info: SELECT age, date, id, name
│ FROM author
│ WHERE id=?
└  LIMIT 1
Main.ex-code_1.Author(DBId{Integer}(1), &quot;pirulo&quot;, 50, 2020-03-07T12:09:25.79)</code></pre><h2 id="Existence-1"><a class="docs-heading-anchor" href="#Existence-1">Existence</a><a class="docs-heading-anchor-permalink" href="#Existence-1" title="Permalink"></a></h2><pre><code class="language-julia">author = Author(name=&quot;Author 1&quot;, age=2)
insert!(mapper, author)

author = Author(name=&quot;Author 2&quot;, age=3)
insert!(mapper, author)

author = Author(name=&quot;Author 3&quot;, age=4)
insert!(mapper, author)

println(exists(mapper, Author, name=&quot;Enrique Banch&quot;))
println(exists(mapper, Author, name=&quot;pirulo&quot;))
println(exists(mapper, author))

println(exists(mapper, Author, name=&quot;Author 3&quot;, age=4))
println(exists(mapper, Author, name=&quot;Author 3&quot;, age=3))
println(exists(mapper, Author, pk=author.id.x, age=3))
println(exists(mapper, Author, pk=author.id.x, age=4))</code></pre><pre><code class="language-none">┌ Info: INSERT INTO author (age,date,name)
└ VALUES (?,?,?)
┌ Info: INSERT INTO author (age,date,name)
└ VALUES (?,?,?)
┌ Info: INSERT INTO author (age,date,name)
└ VALUES (?,?,?)
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE name = ?
false
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE name = ?
true
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE id = ?
true
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE age = ? AND name = ?
true
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE age = ? AND name = ?
false
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE age = ? AND id = ?
false
┌ Info: SELECT COUNT(1) as count
│ FROM author
└ WHERE age = ? AND id = ?
true</code></pre><h2 id="Update-1"><a class="docs-heading-anchor" href="#Update-1">Update</a><a class="docs-heading-anchor-permalink" href="#Update-1" title="Permalink"></a></h2><p>the function <code>update!</code> receives a named argument <code>fields</code> that indicates the fields to be updated</p><pre><code class="language-julia">a.name = &quot;otro_pirulo&quot;
a.age = 5
update!(mapper, a; fields=[:name])
a = select_one(mapper, Author, id=id)
println(a)</code></pre><pre><code class="language-none">┌ Info: UPDATE author
│ SET name=?
│ WHERE
└ id = ?
┌ Info: SELECT age, date, id, name
│ FROM author
│ WHERE id=?
└  LIMIT 1
Main.ex-code_1.Author(DBId{Integer}(1), &quot;otro_pirulo&quot;, 50, 2020-03-07T12:09:25.79)</code></pre><p>If <code>fields</code> is omitted all the fields are updated</p><pre><code class="language-julia">a.name = &quot;some_other_name&quot;
a.age = 5
update!(mapper, a)
a = select_one(mapper, Author, id=id)
println(a)</code></pre><pre><code class="language-none">┌ Info: UPDATE author
│ SET age=?,date=?,name=?
│ WHERE
└ id = ?
┌ Info: SELECT age, date, id, name
│ FROM author
│ WHERE id=?
└  LIMIT 1
Main.ex-code_1.Author(DBId{Integer}(1), &quot;some_other_name&quot;, 5, 2020-03-07T12:09:25.79)</code></pre><h1 id="Insert-element-with-foreign-key-and-dict-1"><a class="docs-heading-anchor" href="#Insert-element-with-foreign-key-and-dict-1">Insert element with foreign key and dict</a><a class="docs-heading-anchor-permalink" href="#Insert-element-with-foreign-key-and-dict-1" title="Permalink"></a></h1><pre><code class="language-julia">book = Book(id=&quot;super_string_id&quot;, author=author,
            data=Dict{String, Integer}(&quot;some_data&quot;=&gt;5))
insert!(mapper, book)</code></pre><pre><code class="language-none">Main.ex-code_1.Book(DBId{String}(&quot;super_string_id&quot;), ForeignKey{Main.ex-code_1.Author}(Main.ex-code_1.Author(DBId{Integer}(4), &quot;Author 3&quot;, 4, 2020-03-07T12:09:29.336), true), Dict{String,Integer}(&quot;some_data&quot; =&gt; 5))</code></pre><pre><code class="language-julia">book = select_one(mapper, Book, id=&quot;bbb&quot;)
println(book)</code></pre><pre><code class="language-none">┌ Info: SELECT author_id, data, id
│ FROM book
│ WHERE id=?
└  LIMIT 1
nothing</code></pre><pre><code class="language-julia">book = select_one(mapper, Book, id=&quot;super_string_id&quot;)
println(book)</code></pre><pre><code class="language-none">┌ Info: SELECT author_id, data, id
│ FROM book
│ WHERE id=?
└  LIMIT 1
Main.ex-code_1.Book(DBId{String}(&quot;super_string_id&quot;), ForeignKey{Main.ex-code_1.Author}(Main.ex-code_1.Author(DBId{Integer}(4), &quot;&quot;, 0, 2020-03-07T12:09:31.424), false), Dict{String,Integer}(&quot;some_data&quot; =&gt; 5))</code></pre><h1 id="Delete-1"><a class="docs-heading-anchor" href="#Delete-1">Delete</a><a class="docs-heading-anchor-permalink" href="#Delete-1" title="Permalink"></a></h1><pre><code class="language-julia">book = select_one(mapper, Book, id=&quot;super_string_id&quot;)
delete!(mapper, book)</code></pre><pre><code class="language-none">┌ Info: SELECT author_id, data, id
│ FROM book
│ WHERE id=?
└  LIMIT 1
┌ Info: DELETE FROM book
└ WHERE id=?</code></pre><h1 id="Removing-tables-1"><a class="docs-heading-anchor" href="#Removing-tables-1">Removing tables</a><a class="docs-heading-anchor-permalink" href="#Removing-tables-1" title="Permalink"></a></h1><pre><code class="language-julia">drop_table!(mapper, Author)
drop_table!(mapper, Book)</code></pre><pre><code class="language-none">[ Info: DROP TABLE author
[ Info: DROP TABLE book</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="api.html">« Api</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 7 March 2020 12:09">Saturday 7 March 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
